<html lang="de" data-google-analytics-opt-out="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trade Pilot - Christian Hohlfeld</title>
    <!-- Hinweis: cdn.tailwindcss.com wird nur fÃ¼r die Entwicklung verwendet. FÃ¼r die Produktion sollte es als PostCSS-Plugin installiert werden. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- BASE SETTINGS --- */
        body { 
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; 
            user-select: none; 
            /* FIX FÃœR SCROLLBAR BEI ROTATION: Erzwingt global hidden */
            overflow: hidden !important; 
            background-color: #020617; 
            color: #f1f5f9; 
            -webkit-tap-highlight-color: transparent;
            height: 100vh; width: 100vw;
            display: flex; align-items: center; justify-content: center;
        }

        /* --- 3D CARD ENGINE --- */
        .scene { 
            perspective: 1200px; z-index: 20; position: relative; 
            /* FIX: HÃ¶he minimal reduziert (750px) und vh auf 80vh angepasst, um Puffer zu schaffen */
            width: 100%; max-width: 420px; height: 80vh; max-height: 750px; min-height: 600px;
        }
        .card {
            position: relative; width: 100%; height: 100%;
            transform-style: preserve-3d; 
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .card.is-flipped { transform: rotateY(180deg); }
        
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border-radius: 1.75rem; 
            overflow: hidden;
            background-color: rgba(30, 41, 59, 0.95); 
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255,255,255,0.05) inset;
            backdrop-filter: blur(16px);
            display: flex; flex-direction: column;
        }
        .card-face-front { z-index: 2; transform: rotateY(0deg); }
        .card-face-back { transform: rotateY(180deg); background-color: rgba(15, 23, 42, 0.98); }

        /* --- BACKGROUND CANVAS --- */
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; touch-action: none; }
        .bg-vignette {
            position: fixed; inset: 0; z-index: 1; pointer-events: none;
            background: radial-gradient(circle at center, rgba(2,6,23,0.3) 0%, rgba(2,6,23,0.95) 90%);
        }

        /* --- INTERACTIONS (NO SCALE) --- */
        .interactive {
            cursor: pointer; 
            transition: opacity 0.1s, background-color 0.1s;
        }
        .interactive:active { opacity: 0.8; }

        /* Ripple */
        .ripple { 
            position: absolute; border-radius: 50%; transform: scale(0); 
            animation: ripple 0.5s ease-out; 
            background-color: rgba(255, 255, 255, 0.1); pointer-events: none; 
        }
        @keyframes ripple { to { transform: scale(3); opacity: 0; } }

        /* --- CONTROLS STYLING --- */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; opacity: 0.6; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #10B981; border: 2px solid #064E3B; 
            cursor: grab; margin-top: -8px; 
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); 
            transition: transform 0.1s ease;
        }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.1); cursor: grabbing; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }

        /* Animations */
        .pulse-text { animation: textPulse 0.4s ease-out; }
        @keyframes textPulse { 
            0% { color: #fff; transform: scale(1); } 
            50% { color: #34d399; transform: scale(1.05); } 
            100% { color: #fff; transform: scale(1); } 
        }

        .loader { border: 2px solid #334155; border-top: 2px solid #10B981; border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Scrollbar */
        .content-scroll { overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
        .content-scroll::-webkit-scrollbar { width: 4px; }
        .content-scroll::-webkit-scrollbar-track { background: transparent; }
        .content-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        /* Toggle */
        .toggle-track { transition: background-color 0.2s ease; }
        .toggle-knob { transition: transform 0.2s cubic-bezier(0.4, 0.0, 0.2, 1); }
        .toggle-checkbox:checked ~ .toggle-track { background-color: #10B981; }
        .toggle-checkbox:checked ~ .toggle-knob { transform: translateX(100%); background-color: white; }

        .hidden { display: none !important; }

        /* Toast */
        #toast-container { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(12px); 
            color: #fff; padding: 10px 20px; border-radius: 99px; 
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1);
            font-size: 13px; font-weight: 500; opacity: 0; transform: translateY(20px); 
            transition: all 0.3s ease-out; pointer-events: auto; 
            display: flex; align-items: center; gap: 10px; 
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* Modals */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 9998; display: none; opacity: 0; transition: opacity 0.3s; }
        .modal-backdrop.show { opacity: 1; }
        .action-sheet { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(120%); 
            background: #1e293b; width: 92%; max-width: 400px; padding: 24px; 
            border-radius: 28px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7); border: 1px solid #334155;
            z-index: 9999; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); 
            display: none; flex-direction: column; gap: 16px; text-align: center; color: white;
        }
        .action-sheet.show { transform: translateX(-50%) translateY(0); }

        .btn-action { padding: 12px; border-radius: 14px; font-weight: 600; font-size: 14px; width: 100%; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: #10B981; color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-primary:hover { background-color: #059669; }
        .btn-secondary { background-color: #334155; color: #cbd5e1; border: 1px solid #475569; }
        .btn-secondary:hover { background-color: #475569; }
        .btn-danger { background-color: #450a0a; color: #fca5a5; border: 1px solid #7f1d1d; }
        .btn-danger:hover { background-color: #7f1d1d; }

        #privacy-reset-btn { position: fixed; bottom: 20px; left: 20px; background-color: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 99px; padding: 8px 16px; cursor: pointer; z-index: 60; display: none; font-size: 11px; color: #94a3b8; transition: all 0.2s; align-items: center; gap: 6px; backdrop-filter: blur(8px); }
        #privacy-reset-btn:hover { color: #ef4444; border-color: #fca5a5; }
        
        /* Chart Tooltip */
        #chart-tooltip {
            position: absolute; pointer-events: none; z-index: 10;
            background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 6px 10px; border-radius: 8px; font-size: 11px; font-family: monospace;
            white-space: nowrap; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        
        /* Badges */
        .stock-badge {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 4px 10px; border-radius: 12px; font-size: 10px; color: #94a3b8;
            cursor: pointer; transition: all 0.2s; font-family: monospace;
        }
        .stock-badge:hover { background: rgba(16, 185, 129, 0.1); color: #34d399; border-color: rgba(16, 185, 129, 0.3); }

        /* Explore Card Styling */
        .explore-card {
            background: #1e293b;
            border: 1px solid #334155;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            border-radius: 1rem;
        }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border-width:0}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0px}.left-0{left:0px}.left-0\.5{left:0.125rem}.right-4{right:1rem}.top-0{top:0px}.top-0\.5{top:0.125rem}.top-3{top:0.75rem}.top-full{top:100%}.z-20{z-index:20}.z-50{z-index:50}.z-\[9999\]{z-index:9999}.col-span-2{grid-column:span 2 / span 2}.mx-auto{margin-left:auto;margin-right:auto}.mb-0\.5{margin-bottom:0.125rem}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-1{margin-top:0.25rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-1{height:0.25rem}.h-10{height:2.5rem}.h-12{height:3rem}.h-20{height:5rem}.h-3{height:0.75rem}.h-4{height:1rem}.h-5{height:1.25rem}.h-full{height:100%}.max-h-60{max-height:15rem}.w-10{width:2.5rem}.w-12{width:3rem}.w-20{width:5rem}.w-3{width:0.75rem}.w-4{width:1rem}.w-5{width:1.25rem}.w-9{width:2.25rem}.w-full{width:100%}.max-w-xs{max-width:20rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.cursor-pointer{cursor:pointer}.select-none{-webkit-user-select:none;user-select:none}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-end{align-items:flex-end}.items-center{align-items:center}.items-baseline{align-items:baseline}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:0.25rem}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.divide-y > :not([hidden]) ~ :not([hidden]){--tw-divide-y-reverse:0;border-top-width:calc(1px * calc(1 - var(--tw-divide-y-reverse)));border-bottom-width:calc(1px * var(--tw-divide-y-reverse))}.divide-slate-700 > :not([hidden]) ~ :not([hidden]){--tw-divide-opacity:1;border-color:rgb(51 65 85 / var(--tw-divide-opacity, 1))}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.rounded{border-radius:0.25rem}.rounded-2xl{border-radius:1rem}.rounded-3xl{border-radius:1.5rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-none{border-style:none}.border-emerald-500\/20{border-color:rgb(16 185 129 / 0.2)}.border-gray-700\/50{border-color:rgb(55 65 81 / 0.5)}.border-slate-700{--tw-border-opacity:1;border-color:rgb(51 65 85 / var(--tw-border-opacity, 1))}.border-slate-700\/50{border-color:rgb(51 65 85 / 0.5)}.border-white\/10{border-color:rgb(255 255 255 / 0.1)}.border-white\/5{border-color:rgb(255 255 255 / 0.05)}.border-gray-700{--tw-border-opacity:1;border-color:rgb(55 65 81 / var(--tw-border-opacity, 1))}.bg-gray-950{--tw-bg-opacity:1;background-color:rgb(3 7 18 / var(--tw-bg-opacity, 1))}.bg-slate-600{--tw-bg-opacity:1;background-color:rgb(71 85 105 / var(--tw-bg-opacity, 1))}.bg-slate-700\/50{background-color:rgb(51 65 85 / 0.5)}.bg-slate-800{--tw-bg-opacity:1;background-color:rgb(30 41 59 / var(--tw-bg-opacity, 1))}.bg-slate-800\/30{background-color:rgb(30 41 59 / 0.3)}.bg-slate-800\/40{background-color:rgb(30 41 59 / 0.4)}.bg-slate-800\/50{background-color:rgb(30 41 59 / 0.5)}.bg-slate-900{--tw-bg-opacity:1;background-color:rgb(15 23 42 / var(--tw-bg-opacity, 1))}.bg-slate-900\/30{background-color:rgb(15 23 42 / 0.3)}.bg-slate-900\/40{background-color:rgb(15 23 42 / 0.4)}.bg-transparent{background-color:transparent}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-gray-700{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity, 1))}.bg-gray-800\/50{background-color:rgb(31 41 55 / 0.5)}.bg-gradient-to-br{background-image:linear-gradient(to bottom right, var(--tw-gradient-stops))}.bg-gradient-to-r{background-image:linear-gradient(to right, var(--tw-gradient-stops))}.from-emerald-500{--tw-gradient-from:#10b981 var(--tw-gradient-from-position);--tw-gradient-to:rgb(16 185 129 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.to-emerald-400{--tw-gradient-to:#34d399 var(--tw-gradient-to-position)}.to-slate-900{--tw-gradient-to:#0f172a var(--tw-gradient-to-position)}.p-0{padding:0px}.p-2{padding:0.5rem}.p-2\.5{padding:0.625rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.py-0\.5{padding-top:0.125rem;padding-bottom:0.125rem}.px-1\.5{padding-left:0.375rem;padding-right:0.375rem}.pb-3{padding-bottom:0.75rem}.pl-1{padding-left:0.25rem}.pl-4{padding-left:1rem}.pt-3{padding-top:0.75rem}.text-center{text-align:center}.text-right{text-align:right}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-2xl{font-size:1.5rem;line-height:2rem}.text-5xl{font-size:3rem;line-height:1}.text-\[10px\]{font-size:10px}.text-\[11px\]{font-size:11px}.text-\[9px\]{font-size:9px}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.uppercase{text-transform:uppercase}.leading-relaxed{line-height:1.625}.tracking-tight{letter-spacing:-0.025em}.tracking-wide{letter-spacing:0.025em}.tracking-wider{letter-spacing:0.05em}.tracking-widest{letter-spacing:0.1em}.text-emerald-400{--tw-text-opacity:1;color:rgb(52 211 153 / var(--tw-text-opacity, 1))}.text-emerald-500{--tw-text-opacity:1;color:rgb(16 185 129 / var(--tw-text-opacity, 1))}.text-red-400{--tw-text-opacity:1;color:rgb(248 113 113 / var(--tw-text-opacity, 1))}.text-slate-200{--tw-text-opacity:1;color:rgb(226 232 240 / var(--tw-text-opacity, 1))}.text-slate-300{--tw-text-opacity:1;color:rgb(203 213 225 / var(--tw-text-opacity, 1))}.text-slate-400{--tw-text-opacity:1;color:rgb(148 163 184 / var(--tw-text-opacity, 1))}.text-slate-500{--tw-text-opacity:1;color:rgb(100 116 139 / var(--tw-text-opacity, 1))}.text-slate-600{--tw-text-opacity:1;color:rgb(71 85 105 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-gray-300{--tw-text-opacity:1;color:rgb(209 213 219 / var(--tw-text-opacity, 1))}.placeholder-slate-600::placeholder{--tw-placeholder-opacity:1;color:rgb(71 85 105 / var(--tw-placeholder-opacity, 1))}.opacity-0{opacity:0}.opacity-90{opacity:0.9}.shadow{--tw-shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color), 0 1px 2px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:inset 0 2px 4px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-xl{--tw-shadow:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 20px 25px -5px var(--tw-shadow-color), 0 8px 10px -6px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.outline-none{outline:2px solid transparent;outline-offset:2px}.drop-shadow-md{--tw-drop-shadow:drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)) drop-shadow(0 2px 2px rgb(0 0 0 / 0.06));filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-blur-md{--tw-backdrop-blur:blur(12px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-200{transition-duration:200ms}.duration-300{transition-duration:300ms}.focus-within\:border-emerald-500\/50:focus-within{border-color:rgb(16 185 129 / 0.5)}.focus-within\:bg-slate-800:focus-within{--tw-bg-opacity:1;background-color:rgb(30 41 59 / var(--tw-bg-opacity, 1))}.hover\:border-white\/10:hover{border-color:rgb(255 255 255 / 0.1)}.hover\:bg-slate-700:hover{--tw-bg-opacity:1;background-color:rgb(51 65 85 / var(--tw-bg-opacity, 1))}.hover\:text-emerald-400:hover{--tw-text-opacity:1;color:rgb(52 211 153 / var(--tw-text-opacity, 1))}.hover\:text-red-400:hover{--tw-text-opacity:1;color:rgb(248 113 113 / var(--tw-text-opacity, 1))}.hover\:text-white:hover{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.focus\:border-emerald-500:focus{--tw-border-opacity:1;border-color:rgb(16 185 129 / var(--tw-border-opacity, 1))}.focus\:ring-1:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(1px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-emerald-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(16 185 129 / var(--tw-ring-opacity, 1))}.group:hover .group-hover\:text-red-400{--tw-text-opacity:1;color:rgb(248 113 113 / var(--tw-text-opacity, 1))}.group:hover .group-hover\:text-slate-300{--tw-text-opacity:1;color:rgb(203 213 225 / var(--tw-text-opacity, 1))}.peer:checked ~ .peer-checked\:translate-x-\[1rem\]{--tw-translate-x:1rem;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.peer:checked ~ .peer-checked\:bg-emerald-500{--tw-bg-opacity:1;background-color:rgb(16 185 129 / var(--tw-bg-opacity, 1))}</style></head>
<body style="overflow: hidden !important;">

    <!-- Background Chart System -->
    <canvas id="bg-canvas" width="567" height="663"></canvas>
    <div class="bg-vignette"></div>
    <div id="chart-tooltip" style="display: block; left: 523.094px; top: 321.161px; transform: translate(-100%, -50%);">170.49â‚¬<br><span class="text-slate-400 text-[9px]">11/1/2024</span></div>

    <!-- Toast -->
    <div id="toast-container"></div>

    <!-- Modals -->
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="generic-modal" class="action-sheet">
        <div id="modal-icon" class="mx-auto w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-2xl border border-slate-700"></div>
        <div>
            <h2 id="modal-title" class="text-xl font-bold text-white"></h2>
            <p id="modal-text" class="text-sm text-slate-400 mt-2 leading-relaxed"></p>
        </div>
        <div id="modal-actions" class="flex flex-col gap-3 w-full"></div>
    </div>

    <!-- Consent Pause Screen -->
    <div id="consent-pause-screen" class="hidden fixed inset-0 bg-gray-950 z-[9999] flex flex-col justify-center p-8 text-center hidden">
        <div class="max-w-xs w-full">
            <div class="text-5xl mb-6">ðŸ”’</div>
            <h3 class="text-2xl font-bold text-white mb-2">Gesperrt</h3>
            <p class="text-slate-400 text-sm mb-8">Die App benÃ¶tigt lokalen Speicherzugriff.</p>
            <button onclick="decideConsent(true)" class="btn-action btn-primary">Freigeben</button>
        </div>
    </div>

    <!-- 3D SCENE -->
    <div class="scene">
        <div class="card" id="main-card">
            
            <!-- FRONT -->
            <div class="card-face card-face-front shadow-2xl">
                
                <!-- Header (Fixed) -->
                <div class="p-5 pb-3 flex justify-between items-start border-b border-gray-700/50 bg-slate-800/30 backdrop-blur-md flex-shrink-0">
                    <div class="flex items-start gap-3">
                        <button onclick="toggleFlip()" class="interactive p-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition-colors border border-gray-700/50" title="Historie [Leertaste]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                        </button>
                        <div>
                            <h1 class="text-xl font-bold tracking-tight text-white">Trade Pilot</h1>
                            <!-- User Name + Logout (IMPROVED LAYOUT) -->
                            <div class="flex items-center gap-1.5 group cursor-pointer mt-0.5" onclick="logout()">
                                <p class="text-slate-500 text-[10px] font-bold tracking-widest uppercase group-hover:text-slate-300 transition-colors" id="user-display-name">Christian Heinrich Hohlfeld</p>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600 group-hover:text-red-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <!-- NEU: Save/Load / Unmute / Asset Toggle Buttons -->
                    <div class="flex items-center gap-2">
                        <!-- YAHOO FINANCE LINK -->
                        <a id="yahooLink" href="https://finance.yahoo.com/quote/GOOG" target="_blank" class="interactive p-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-emerald-400 transition-colors border border-gray-700/50" title="Yahoo Finance">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        </a>
                         <!-- Asset Mode Toggle (STOCK / CRYPTO) - NEU HIER PLATZIERT -->
                        <label class="flex items-center cursor-pointer gap-2 select-none group interactive p-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 transition-colors border border-gray-700/50" onclick="AudioEngine.playImpact('plastic');">
                            <div class="relative w-9 h-5">
                                <input type="checkbox" id="assetModeToggle" class="peer sr-only" onchange="toggleAssetMode()">
                                <div class="w-full h-full bg-slate-600 rounded-full shadow-inner peer-checked:bg-emerald-500 transition-colors duration-200 toggle-track"></div>
                                <div class="absolute left-0.5 top-0.5 bg-white w-4 h-4 rounded-full shadow transition-transform duration-200 peer-checked:translate-x-[1rem] toggle-knob"></div>
                            </div>
                            <span class="text-[11px] font-bold text-slate-500 uppercase tracking-wide group-hover:text-slate-300 transition-colors" id="assetModeLabel">Aktie</span>
                        </label>
                        
                        <!-- UNMUTE/MUTE BUTTON -->
                        <button id="unmuteButton" onclick="AudioEngine.unmute()" class="interactive p-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition-colors border border-gray-700/50" title="Sound aktivieren">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9.383 3.003h.334c1.192 0 2.378.085 3.565.253a.75.75 0 01.696.653 18.06 18.06 0 01.385 4.301c.07.728-.21 1.45-.77 1.884l-.19.143a.75.75 0 00-.285 1.054c.48.74 1.132 1.412 1.932 1.977l.21.154c.7.514 1.632.748 2.53.642.597-.07.97-.6.86-1.2l-.56-3.153a.75.75 0 00-.73-.615h-.89a.75.75 0 00-.73.615l-.56 3.153c-.01.07-.05.13-.106.184l-.19.143c-.45.33-.872.583-1.282.723a.75.75 0 01-.84.095 16.59 16.59 0 00-3.504-.252h-.334A.75.75 0 009.05 15.01V4.99c0-.414.336-.75.75-.75zM5.5 8a.5.5 0 000 1h2a.5.5 0 000-1h-2zm-2.5.5a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                        
                        <button onclick="exportData()" class="interactive p-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition-colors border border-gray-700/50" title="Daten speichern/Backup">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        </button>
                        <button onclick="document.getElementById('importFile').click()" class="interactive p-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition-colors border border-gray-700/50" title="Daten laden/Import">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        </button>
                        <input type="file" id="importFile" accept=".json" class="hidden" onchange="importData(this)">
                    </div>
                    <!-- Ende NEU: Header Buttons -->
                </div>

                <!-- Content (Scrollable) -->
                <div class="flex-1 content-scroll p-5 space-y-4 bg-slate-900/30">
                    
                    <!-- Login Overlay -->
                    <div id="login-overlay" class="absolute inset-0 bg-slate-900 z-50 flex flex-col justify-center p-8 text-center hidden">
                        <div class="w-20 h-20 rounded-3xl bg-slate-800 mx-auto flex items-center justify-center mb-6 shadow-lg border border-slate-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">Willkommen</h2>
                        <input type="text" id="username-input" placeholder="Ihr Name" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white mb-4 outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 text-center transition-all">
                        <button onclick="performLogin()" class="btn-action btn-primary shadow-lg">Starten</button>
                    </div>

                    <!-- Search -->
                    <div class="space-y-2">
                        <div class="relative z-20 group bg-slate-800/50 rounded-xl border border-white/10 focus-within:border-emerald-500/50 focus-within:bg-slate-800 transition-colors">
                            <div class="flex items-center">
                                <div class="pl-4 text-slate-500">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                </div>
                                <input type="text" id="searchInput" placeholder="Aktie suchen..." class="flex-1 p-3 bg-slate-800/50 border-none outline-none text-slate-200 placeholder-slate-600 font-medium text-sm focus:bg-slate-800 transition-colors" oninput="toggleDailyPriceEdit()" onkeydown="if(event.key === 'Enter') searchStock()">
                            </div>
                            <div id="searchResults" class="content-scroll hidden absolute top-full left-0 w-full bg-slate-800 shadow-2xl border border-slate-700 rounded-xl mt-2 max-h-60 overflow-y-auto z-50 divide-y divide-slate-700"></div>
                            <div id="loadingIndicator" class="absolute right-4 top-3 hidden"><span class="loader"></span></div>
                        </div>
                        <!-- Recent Searches (Badges) -->
                        <div id="recent-searches" class="flex flex-wrap gap-2 pl-1"><span class="stock-badge" onclick="fetchPrice('GOOG')">GOOG</span><span class="stock-badge" onclick="fetchPrice('AAPL')">AAPL</span></div>
                    </div>

                    <!-- Trending Section (NEW) -->
                    <div class="explore-card p-4 space-y-3">
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider flex justify-between items-center">
                            <span id="trendingTitle">Trending Heute (Aktie)</span>
                            <svg onclick="fetchTrendingAssets(true)" class="h-4 w-4 text-slate-500 interactive hover:text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 10v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </h3>
                        <div id="trending-list" class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-slate-900/40 rounded-xl border border-slate-700/50 flex flex-col justify-between interactive transition-colors hover:bg-slate-700/50" onclick="fetchPrice('MSFT')">
                                <span class="text-white font-bold text-sm">MSFT</span>
                                <span class="text-xs text-emerald-400 font-mono mt-1">+1.5%</span>
                            </div>
                            <div class="p-3 bg-slate-900/40 rounded-xl border border-slate-700/50 flex flex-col justify-between interactive transition-colors hover:bg-slate-700/50" onclick="fetchPrice('AMZN')">
                                <span class="text-white font-bold text-sm">AMZN</span>
                                <span class="text-xs text-red-400 font-mono mt-1">-0.8%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Inputs -->
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Kaufkurs (Historisch) -->
                        <div class="bg-slate-800/40 p-3 rounded-xl border border-white/5 hover:border-white/10 transition-colors interactive">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-0.5">Kaufkurs (Historisch)</label>
                            <div class="flex items-baseline gap-1">
                                <input type="number" id="buyPrice" value="258.00" step="0.01" class="w-full bg-transparent p-0 text-right font-mono text-lg font-bold text-white outline-none" oninput="saveAndCalc()">
                                <span class="text-xs text-slate-500 font-bold">â‚¬</span>
                            </div>
                        </div>
                        <!-- Tageskurs (Aktuell - NEU) -->
                        <div id="dailyPriceContainer" class="bg-slate-800/40 p-3 rounded-xl border border-white/5 hover:border-white/10 transition-colors interactive">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-0.5">Tageskurs (Aktuell)</label>
                            <div class="flex items-baseline gap-1">
                                <input type="number" id="dailyPrice" value="258.00" step="0.01" class="w-full bg-transparent p-0 text-right font-mono text-lg font-bold text-white outline-none" oninput="saveAndCalc()">
                                <span class="text-xs text-slate-500 font-bold">â‚¬</span>
                            </div>
                        </div>
                        <!-- Anzahl -->
                        <div class="bg-slate-800/40 p-3 rounded-xl border border-white/5 hover:border-white/10 transition-colors interactive">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-0.5">Anzahl</label>
                            <input type="number" id="quantity" value="2" step="1" class="w-full bg-transparent p-0 text-right font-mono text-lg font-bold text-white outline-none" oninput="saveAndCalc()">
                        </div>
                        <!-- Kaufdatum -->
                        <div class="col-span-2 bg-slate-800/40 p-2.5 px-3 rounded-xl border border-white/5 hover:border-white/10 transition-colors flex justify-between items-center interactive" id="purchaseDateContainer">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Kaufdatum</label>
                            <input type="datetime-local" id="purchaseDate" class="bg-transparent border-none p-0 text-right font-mono text-xs font-medium text-slate-300 outline-none tracking-wide">
                        </div>
                    </div>

                    <!-- Settings Box -->
                    <div class="bg-slate-800/30 p-4 rounded-2xl border border-white/5">
                        <div class="flex justify-between items-center mb-4">
                            
                            <!-- Tax Toggle -->
                            <label class="flex items-center cursor-pointer gap-2 select-none group interactive" onclick="AudioEngine.playImpact('plastic')">
                                <div class="relative w-9 h-5">
                                    <input type="checkbox" id="taxToggle" class="peer sr-only" onchange="handleToggle()">
                                    <div class="w-full h-full bg-slate-600 rounded-full shadow-inner peer-checked:bg-emerald-500 transition-colors duration-200"></div>
                                    <div class="absolute left-0.5 top-0.5 bg-white w-4 h-4 rounded-full shadow transition-transform duration-200 peer-checked:translate-x-[1rem]"></div>
                                </div>
                                <span class="text-[11px] font-bold text-slate-500 uppercase tracking-wide group-hover:text-slate-300 transition-colors">Steuer</span>
                            </label>
                            
                        </div>
                        
                        <div class="flex justify-between items-center mb-4">
                             <!-- Spacer (to align Profit Mode) -->
                            <div class="w-9 h-5"></div>
                            
                            <!-- Profit Mode Toggle -->
                            <label class="flex items-center cursor-pointer gap-2 select-none group interactive" onclick="AudioEngine.playImpact('plastic')">
                                <span class="text-[11px] font-bold text-slate-500 uppercase tracking-wide group-hover:text-slate-300 transition-colors" id="profitModeLabel">Gewinn in â‚¬</span>
                                <div class="relative w-9 h-5">
                                    <input type="checkbox" id="profitModeToggle" class="peer sr-only" onchange="toggleProfitMode()">
                                    <div class="w-full h-full bg-slate-600 rounded-full shadow-inner peer-checked:bg-emerald-500 transition-colors duration-200"></div>
                                    <div class="absolute left-0.5 top-0.5 bg-white w-4 h-4 rounded-full shadow transition-transform duration-200 peer-checked:translate-x-[1rem]"></div>
                                </div>
                            </label>
                        </div>


                        <div class="flex justify-between items-end mb-2">
                            <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider">Ziel</label>
                            <span class="text-xl font-bold text-emerald-400 font-mono transition-all" id="targetProfitDisplay">0,00&nbsp;â‚¬</span>
                        </div>
                        <input type="range" id="profitSlider" min="0" max="500" value="0" step="1" class="w-full" oninput="handleSlider(this)">
                    </div>

                    <!-- Result Card (Invest & Target) -->
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-xl border border-slate-700 relative overflow-hidden group interactive">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-emerald-400 opacity-90"></div>
                        
                        <!-- Investment Breakdown (NEW) -->
                        <div class="p-5 pb-3 border-b border-slate-700/50">
                            <p class="text-[10px] text-slate-500 uppercase tracking-widest mb-2">Investitionskosten</p>
                            <div class="grid grid-cols-2 gap-1 text-xs font-mono text-slate-400">
                                <span class="text-slate-500">Kaufdatum:</span>
                                <span class="text-right text-slate-300" id="purchaseDateDisplay">01.01.2025</span>
                                <span class="text-slate-500" id="rawShareLabel">Aktienwert:</span>
                                <span class="text-right text-slate-300" id="rawShareValue">0,00 â‚¬</span>
                                <span class="text-slate-500" id="buyFeesLabel">KaufgebÃ¼hren:</span>
                                <span class="text-right text-slate-300" id="buyFees">0,00 â‚¬</span>
                            </div>
                            <div class="flex justify-end mt-2 pt-2 border-t border-slate-700/50">
                                <div class="flex flex-col items-end">
                                    <p class="text-[10px] text-slate-500 uppercase tracking-widest mb-0.5">Gesamt (Invest)</p>
                                    <p class="text-base font-mono text-white font-bold" id="totalInvested">605,70&nbsp;â‚¬</p>
                                </div>
                            </div>
                        </div>

                        <!-- Target Calculation Result -->
                        <div class="p-5 pt-3">
                            <div class="flex justify-between items-end mb-1">
                                <div class="text-slate-600 mb-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg></div>
                                <div class="text-right">
                                    <p class="text-[10px] text-emerald-500 uppercase tracking-widest mb-0.5">Verkauf (Ziel)</p>
                                    <p class="text-2xl font-bold font-mono text-white tracking-tight drop-shadow-md pulse-text" id="requiredSellPriceTotal">612,13&nbsp;â‚¬</p>
                                </div>
                            </div>
                            <div class="border-t border-slate-700/50 mt-3 pt-3 flex justify-between items-center">
                                <span class="text-[11px] text-slate-400" id="targetKursLabel">Kurs (Ziel): <span id="requiredSellPriceShare" class="text-white font-mono font-bold">306,06&nbsp;â‚¬</span></span>
                                <span id="percentChangeTarget" class="text-[11px] font-bold bg-slate-700/50 px-2 py-0.5 rounded text-emerald-400 border border-emerald-500/20">+2.14 %</span>
                            </div>
                        </div>

                        <!-- Current P&L -->
                        <div class="bg-slate-900/40 p-5 pt-3 border-t border-slate-700/50 flex justify-between items-center">
                            <span class="text-[11px] text-slate-400 uppercase tracking-wide" id="currentPnLLabel">Aktuelle Performance (Aktie)</span>
                            <span id="currentPnL" class="text-[11px] font-bold px-2 py-0.5 rounded text-slate-400 bg-slate-700/50 border border-slate-700">+0.00 % (0,00 â‚¬)</span>
                        </div>
                    </div>

                    <div class="flex justify-between text-[10px] text-slate-500 px-2">
                        <span>Gesamt-GebÃ¼hren: <span id="totalFees" class="text-slate-400 font-medium">12,83&nbsp;â‚¬</span></span>
                        <span id="taxInfo" class="opacity-0 transition-opacity duration-300" style="opacity: 1;">Steuer (Ziel): <span id="taxAmount" class="text-red-400 font-medium">0,00&nbsp;â‚¬</span></span>
                    </div>

                    <button onclick="saveTrade()" class="btn-action btn-secondary bg-slate-800 text-white border-slate-700 shadow-lg flex items-center justify-center gap-2 mt-1 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        Sichern
                    </button>
                </div>
            </div>

            <!-- BACK: HISTORIE -->
            <div class="card-face card-face-back flex flex-col">
                <div class="p-6 pb-3 border-b border-gray-700/50 flex justify-between items-center bg-slate-800/30 backdrop-blur-md flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <button onclick="toggleFlip()" class="interactive p-2 rounded-full bg-slate-800 hover:bg-slate-700 text-emerald-500 transition-colors border border-slate-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        </button>
                        <h2 class="text-lg font-bold text-white">Historie</h2>
                    </div>
                    <div class="flex gap-2">
                        <!-- Removed buttons from here as they are now in the main header -->
                        <button onclick="askReset()" class="p-2 rounded-lg bg-slate-800 text-slate-400 hover:text-red-400 border border-slate-700 transition-colors interactive" title="Alles lÃ¶schen"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                </div>
                <!-- Toggle fÃ¼r die Steueranzeige in der Historie -->
                <div class="px-5 pt-3 flex justify-end">
                    <label class="flex items-center cursor-pointer gap-2 select-none group interactive" onclick="AudioEngine.playImpact('plastic')">
                        <span class="text-[11px] font-bold text-slate-500 uppercase tracking-wide group-hover:text-slate-300 transition-colors">P&L inkl. Steuer</span>
                        <div class="relative w-9 h-5">
                            <input type="checkbox" id="taxHistoryToggle" class="peer sr-only" onchange="renderTrades()">
                            <div class="w-full h-full bg-slate-600 rounded-full shadow-inner peer-checked:bg-emerald-500 transition-colors duration-200"></div>
                            <div class="absolute left-0.5 top-0.5 bg-white w-4 h-4 rounded-full shadow transition-transform duration-200 peer-checked:translate-x-[1rem]"></div>
                        </div>
                    </label>
                </div>
                <div id="trades-list" class="flex-1 content-scroll p-5 space-y-3">
                    <div class="text-center text-gray-600 text-xs italic mt-10">Keine EintrÃ¤ge.</div>
                </div>
                <div class="p-3 border-t border-gray-700/50 text-center bg-slate-800/30 flex-shrink-0">
                    <p class="text-[9px] text-slate-500 uppercase tracking-widest">Christian Heinrich Hohlfeld Software</p>
                </div>
            </div>

        </div>
    </div>

    <button id="privacy-reset-btn" onclick="revokeConsent()" style="display: block;">Reset</button>

    <script>
        // === 1. AUDIO ENGINE ===
        const AudioEngine = {
            ctx: null, masterGain: null,
            isUnlocked: false,
            init: function() {
                if (!this.ctx) {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC(); this.masterGain = this.ctx.createGain();
                    this.masterGain.gain.value = 0.15; this.masterGain.connect(this.ctx.destination);
                }
                // NEU: AudioContext nur fortsetzen/starten, wenn noch nicht freigeschaltet
                if (this.ctx.state === 'suspended' && this.isUnlocked) this.ctx.resume();
            },
            unmute: function() {
                this.init();
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume().then(() => {
                        this.isUnlocked = true;
                        document.getElementById('unmuteButton').classList.add('hidden');
                        this.playImpact('plastic');
                        // Store the unlocked state
                        localStorage.setItem('audio_unlocked', 'true'); 
                        console.log("AudioContext resumed and unlocked.");
                    }).catch(e => {
                        console.error("Failed to resume AudioContext:", e);
                    });
                } else if (this.ctx.state === 'running') {
                    this.isUnlocked = true;
                    document.getElementById('unmuteButton').classList.add('hidden');
                    this.playImpact('plastic');
                    localStorage.setItem('audio_unlocked', 'true');
                }
            },
            playImpact: function(mat) {
                // Nur abspielen, wenn Context freigeschaltet ist
                if (!this.isUnlocked) return; 

                this.init(); const now = this.ctx.currentTime; const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                if (mat === 'glass') { o.type='sine'; o.frequency.setValueAtTime(400, now); g.gain.setValueAtTime(0.05, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.1); }
                else if (mat === 'plastic') { o.type='triangle'; o.frequency.setValueAtTime(200, now); g.gain.setValueAtTime(0.06, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.1); }
                else { o.type='sine'; o.frequency.setValueAtTime(80, now); g.gain.setValueAtTime(0.08, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.15); }
                o.connect(g); g.connect(this.masterGain); o.start(now); o.stop(now+0.2);
            },
            playTick: function() { 
                if (!this.isUnlocked) return;
                this.init(); const now = this.ctx.currentTime; const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                o.type='sine'; o.frequency.setValueAtTime(300, now); 
                g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.1, now+0.005); g.gain.exponentialRampToValueAtTime(0.001, now+0.05);
                o.connect(g); g.connect(this.masterGain); o.start(now); o.stop(now+0.06);
            },
            playSuccess: function() {
                if (!this.isUnlocked) return;
                this.init(); const now = this.ctx.currentTime; 
                // NEU: Tiefere, weichere Frequenzen fÃ¼r einen angenehmeren "Erfolg"-Sound.
                [440.00, 660.00].forEach(f => {
                    const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                    o.type='sine'; o.frequency.value=f; g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.08, now+0.05); g.gain.exponentialRampToValueAtTime(0.001, now+1.0);
                    o.connect(g); g.connect(this.masterGain); o.start(now); o.stop(now+1.0);
                });
            },
            playSwoosh: function() {
                if (!this.isUnlocked) return;
                this.init(); const now = this.ctx.currentTime; const b = this.ctx.createBuffer(1, this.ctx.sampleRate*0.3, this.ctx.sampleRate);
                const d = b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
                const s = this.ctx.createBufferSource(); s.buffer=b;
                const f = this.ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.setValueAtTime(400, now); f.frequency.exponentialRampToValueAtTime(50, now+0.3);
                const g = this.ctx.createGain(); g.gain.setValueAtTime(0.1, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.3);
                s.connect(f); f.connect(g); g.connect(this.masterGain); s.start(now);
            }
        };

        // === 2. INTERACTIONS ===
        document.addEventListener('mousedown', (e) => {
            // Unmute the audio context on first user click if necessary
            if (!AudioEngine.isUnlocked) {
                AudioEngine.unmute();
            }

            const r = document.createElement("div"); r.className = "ripple";
            r.style.left = (e.clientX-10)+"px"; r.style.top = (e.clientY-10)+"px"; r.style.width="20px"; r.style.height="20px";
            document.body.appendChild(r); setTimeout(()=>r.remove(), 500);
            const t = e.target; let mat = 'soft';
            if(t.closest('input, textarea')) mat='glass'; else if(t.closest('.interactive, button, label')) mat='plastic';
            if(t.tagName!=='INPUT' || t.type!=='range') AudioEngine.playImpact(mat);
        });
        document.addEventListener('keydown', (e) => { if(e.code==='Space' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) { e.preventDefault(); toggleFlip(); } });

        // === 3. APP STATE & CONFIG ===
        // KEYS for Local Storage: U=User, C=Consent, D_x=Data, T_x=Trades, H_x=History
        const KEYS = { 
            C:'ing_cons', U:'ing_user', 
            D_STOCKS: 'ing_data_stocks', D_CRYPTO: 'ing_data_crypto',
            T_STOCKS: 'ing_trade_stocks', T_CRYPTO: 'ing_trade_crypto',
            H_STOCKS: 'ing_history_stocks', H_CRYPTO: 'ing_history_crypto'
        };
        
        let profitMode = 'EUR';
        let assetMode = 'STOCKS'; // NEW: Default mode is STOCKS
        let chartData = null;

        function toggleFlip() { AudioEngine.playSwoosh(); document.getElementById('main-card').classList.toggle('is-flipped'); }
        
        // Exposed Functions
        window.initConsent = function() {
            const s = localStorage.getItem(KEYS.C);
            const o=document.getElementById('consent-overlay'), b=document.getElementById('consent-initial-backdrop'), p=document.getElementById('consent-pause-screen'), r=document.getElementById('privacy-reset-btn');
            document.body.style.overflow='auto';
            if(s==='true') { 
                if(o)o.style.display='none'; if(b)b.style.display='none'; if(p)p.classList.add('hidden'); if(r)r.style.display='block'; 
                checkLogin(); 
                AudioEngine.init(); // Initialize the context, but don't resume/play automatically
            }
            else if(s==='false') { if(o)o.style.display='none'; if(b)b.style.display='none'; if(p)p.classList.remove('hidden'); }
            else { showModal('consent', 'Datenschutz', 'Wir speichern Daten lokal.', [{label:'Akzeptieren', cls:'btn-action btn-primary', cb:()=>window.decideConsent(true)}, {label:'Ablehnen', cls:'btn-action btn-secondary', cb:()=>window.decideConsent(false)}]); }
        };
        window.decideConsent = function(a) { localStorage.setItem(KEYS.C, a?'true':'false'); if(a) { AudioEngine.playImpact('plastic'); window.initConsent(); } else { location.reload(); } };
        
        window.askReset = function() { 
            showModal('warn', 'LÃ¶schen?', 'Alle Daten lÃ¶schen?', [{
                label:'LÃ¶schen', cls:'btn-action btn-danger', 
                cb:()=>{ 
                    localStorage.removeItem(KEYS.U);
                    localStorage.removeItem(KEYS.D_STOCKS);
                    localStorage.removeItem(KEYS.D_CRYPTO);
                    localStorage.removeItem(KEYS.T_STOCKS);
                    localStorage.removeItem(KEYS.T_CRYPTO);
                    localStorage.removeItem(KEYS.H_STOCKS);
                    localStorage.removeItem(KEYS.H_CRYPTO);
                    location.reload(); 
                }}, 
                {label:'Abbrechen', cls:'btn-action btn-secondary'}
            ]); 
        };

        function checkLogin() {
            const u = localStorage.getItem(KEYS.U);
            const ov = document.getElementById('login-overlay');
            if(u) { ov.classList.add('hidden'); document.getElementById('user-display-name').textContent = u; loadState(); renderTrades(); updateRecentsUI(); }
            else { ov.classList.remove('hidden'); document.getElementById('username-input').value = "Christian Heinrich Hohlfeld"; }
        }
        window.performLogin = function() { localStorage.setItem(KEYS.U, document.getElementById('username-input').value.trim()||"Anonym"); AudioEngine.playSuccess(); checkLogin(); };
        window.logout = function() { localStorage.removeItem(KEYS.U); location.reload(); };

        function updateAssetUI() {
            const isCrypto = assetMode === 'CRYPTO';
            
            // UI elements for the Asset Mode Toggle (in Header)
            if (document.getElementById('assetModeLabel')) {
                document.getElementById('assetModeLabel').textContent = isCrypto ? 'Krypto' : 'Aktie';
            }
            
            // UI elements for the calculation breakdown
            if (document.getElementById('rawShareLabel')) {
                document.getElementById('rawShareLabel').textContent = isCrypto ? 'Coin-Wert:' : 'Aktienwert:';
            }
            if (document.getElementById('buyFeesLabel')) {
                document.getElementById('buyFeesLabel').textContent = isCrypto ? 'Krypto-GebÃ¼hr:' : 'KaufgebÃ¼hren:';
            }
            if (document.getElementById('targetKursLabel')) {
                document.getElementById('targetKursLabel').textContent = isCrypto ? 'Coin (Ziel):' : 'Kurs (Ziel):';
            }
            if (document.getElementById('currentPnLLabel')) {
                document.getElementById('currentPnLLabel').textContent = isCrypto ? 'Aktuelle Performance (Krypto)' : 'Aktuelle Performance (Aktie)';
            }
            if (document.getElementById('searchInput')) {
                document.getElementById('searchInput').placeholder = isCrypto ? 'Krypto suchen (z.B. BTC-EUR)' : 'Aktie suchen...';
            }
            
            if (document.getElementById('trendingTitle')) {
                document.getElementById('trendingTitle').textContent = isCrypto ? 'Trending Heute (Krypto)' : 'Trending Heute (Aktie)';
            }

            // Check if search symbol is appropriate for the current mode, if not, clear it
            const currentSym = document.getElementById('searchInput').value;
            // Clears search input if the symbol format doesn't match the current mode (e.g., stock symbol in crypto mode)
            if (currentSym && (isCrypto && !isCryptoSymbol(currentSym)) || (!isCrypto && isCryptoSymbol(currentSym))) {
                 document.getElementById('searchInput').value = '';
            }
        }
        
        window.toggleAssetMode = function() {
            // 1. Save the state of the CURRENT mode before switching
            saveState();

            // 2. Switch the mode
            const chk = document.getElementById('assetModeToggle');
            assetMode = chk.checked ? 'CRYPTO' : 'STOCKS';
            
            // 3. Update UI and load the NEW mode's state
            updateAssetUI();
            loadState(false); // Load state for the new mode, do not save current state again
            
            // Re-run dependencies for the new mode
            // NOTE: toggleDailyPriceEdit is handled inside loadState/fetchPrice.
            renderTrades(); 
            updateRecentsUI();
            fetchTrendingAssets(); 
        }

        function getCurrentDataKey() {
            return assetMode === 'STOCKS' ? KEYS.D_STOCKS : KEYS.D_CRYPTO;
        }

        function getCurrentHistoryKey() {
             return assetMode === 'STOCKS' ? KEYS.T_STOCKS : KEYS.T_CRYPTO;
        }

        function getCurrentRecentsKey() {
             return assetMode === 'STOCKS' ? KEYS.H_STOCKS : KEYS.H_CRYPTO;
        }


        function loadState(initialLoad = true) {
            const currentKey = getCurrentDataKey();
            const r = localStorage.getItem(currentKey);
            
            // Set safe/default texts for all display elements before potentially loading old values
            const setSafeText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };

            setSafeText('requiredSellPriceTotal', '0,00 â‚¬');
            setSafeText('requiredSellPriceShare', '0,00 â‚¬');
            setSafeText('percentChangeTarget', '+0.00 %');
            setSafeText('totalInvested', '0,00 â‚¬');
            setSafeText('totalFees', '0,00 â‚¬');
            setSafeText('taxAmount', '0,00 â‚¬');
            setSafeText('currentPnL', '+0.00 % (0,00 â‚¬)');
            
            // Set current time for date picker on load
            if (initialLoad) {
                const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                const purchaseDateEl = document.getElementById('purchaseDate');
                if(purchaseDateEl) purchaseDateEl.value = now.toISOString().slice(0,16);
            }

            // Reset inputs to default before loading saved state
            document.getElementById('buyPrice').value = "0.00";
            document.getElementById('dailyPrice').value = "0.00";
            document.getElementById('quantity').value = "0";
            document.getElementById('searchInput').value = "";
            document.getElementById('profitSlider').value = "0";
            document.getElementById('taxToggle').checked = false;
            document.getElementById('profitModeToggle').checked = false;
            profitMode = 'EUR';

            // Load saved state for the current mode
            if(!r) { 
                document.getElementById('dailyPrice').value = document.getElementById('buyPrice').value;
                toggleDailyPriceEdit();
                updateAssetUI();
                calculate(); 
                fetchTrendingAssets();
                return; 
            }

            try {
                const d = JSON.parse(r);
                
                // Note: assetMode, assetModeToggle, and profitMode are already set/updated by toggleAssetMode/updateAssetUI if coming from a switch

                if(d.bp) document.getElementById('buyPrice').value = d.bp;
                if(d.dp) document.getElementById('dailyPrice').value = d.dp; 
                else document.getElementById('dailyPrice').value = document.getElementById('buyPrice').value;
                
                if(d.qty) document.getElementById('quantity').value = d.qty;
                
                // Restore remaining controls
                if(d.sym) document.getElementById('searchInput').value = d.sym; 
                if(d.ps) document.getElementById('profitSlider').value = d.ps;
                if(d.tt!==undefined) { document.getElementById('taxToggle').checked = d.tt; handleToggle(false); }
                if(d.pm) { document.getElementById('profitModeToggle').checked = (d.pm==='PERCENT'); toggleProfitMode(false); }
                
                toggleDailyPriceEdit();
                
                // If a symbol is present, fetch the latest price and calculate
                if(d.sym) { 
                    fetchPrice(d.sym); 
                } else {
                    calculate();
                }

                fetchTrendingAssets();

            } catch(e) { console.error("Error loading state:", e); }
        }

        window.saveState = function() {
            if(localStorage.getItem(KEYS.C)!=='true') return;
            const currentKey = getCurrentDataKey();

            const d = {
                bp: document.getElementById('buyPrice').value,
                dp: document.getElementById('dailyPrice').value,
                qty: document.getElementById('quantity').value,
                ps: document.getElementById('profitSlider').value, 
                tt: document.getElementById('taxToggle').checked,
                sym: document.getElementById('searchInput').value,
                pm: document.getElementById('profitModeToggle').checked ? 'PERCENT' : 'EUR',
                am: assetMode 
            };
            localStorage.setItem(currentKey, JSON.stringify(d));
        }
        window.saveAndCalc = function() { calculate(); saveState(); };
        
        // NEU: Logik zur Deaktivierung des Tageskurses
        window.toggleDailyPriceEdit = function() {
            const searchInput = document.getElementById('searchInput').value.trim();
            const dailyPriceInput = document.getElementById('dailyPrice');
            const dailyPriceContainer = document.getElementById('dailyPriceContainer');
            
            // Tageskurs ist NICHT editierbar, wenn ein Symbol vorhanden ist (Muss vom Markt kommen)
            const isDisabled = searchInput && searchInput !== 'Manuell' && dailyPriceInput;

            if (dailyPriceInput) {
                dailyPriceInput.disabled = isDisabled;
            }
            if (dailyPriceContainer) {
                dailyPriceContainer.classList.toggle('opacity-50', isDisabled);
                dailyPriceContainer.classList.toggle('pointer-events-none', isDisabled);
                
                if (isDisabled) {
                    dailyPriceContainer.classList.remove('hover:border-white/10');
                } else {
                    dailyPriceContainer.classList.add('hover:border-white/10');
                }
            }
        };

        // === LOGIC ===
        const fmt = (n) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(n);
        const fmtDateTime = (isoString) => {
            if (!isoString) return 'Unbekannt';
            try {
                const date = new Date(isoString);
                const datePart = date.toLocaleDateString('de-DE');
                const timePart = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                return `${datePart} ${timePart}`;
            } catch (e) {
                return 'Fehler';
            }
        };
        
        // NEW: Dynamic Fee Calculation based on Asset Mode
        const calcFee = (v, mode = assetMode) => {
            if (mode === 'CRYPTO') {
                // Simplified Crypto Fee (e.g., 0.005% of transaction volume, no min/max)
                return v * 0.00005; // 0.005% is 0.00005
            } else {
                // Standard Stock Fee (4.90 + 0.25% up to 69.90 max)
                let f = 4.90 + (v * 0.0025);
                return f > 69.90 ? 69.90 : f;
            }
        };
        let prevRes = 0;

        window.toggleProfitMode = function(calc = true) {
            const chk = document.getElementById('profitModeToggle');
            profitMode = chk.checked ? 'PERCENT' : 'EUR';
            const slider = document.getElementById('profitSlider');
            document.getElementById('profitModeLabel').textContent = chk.checked ? "Gewinn in %" : "Gewinn in â‚¬";
            if (chk.checked) { slider.max = 100; slider.step = 0.5; } else { slider.max = 500; slider.step = 1; }
            if (calc) calculate();
        };
        window.handleToggle = function(sound=true) {
            const c = document.getElementById('taxToggle');
            const taxInfoEl = document.getElementById('taxInfo');
            if (taxInfoEl) {
                taxInfoEl.style.opacity = c.checked ? '1' : '0';
            }
            saveAndCalc();
        };
        window.handleSlider = function(el) {
            const now = Date.now();
            if(!el.ls || (now-el.ls)>40) { if(el.value!=el.lv) { AudioEngine.playTick(); el.ls=now; el.lv=el.value; } }
            calculate();
        }

        function calculate() {
            // FIX: Ensure all elements are retrieved safely before reading values
            const buyPriceEl = document.getElementById('buyPrice');
            const dailyPriceEl = document.getElementById('dailyPrice');
            const quantityEl = document.getElementById('quantity');
            const profitSliderEl = document.getElementById('profitSlider');
            const taxToggleEl = document.getElementById('taxToggle');
            const purchaseDateEl = document.getElementById('purchaseDate');

            if (!buyPriceEl || !dailyPriceEl || !quantityEl || !profitSliderEl || !taxToggleEl || !purchaseDateEl) {
                console.error("Critical calculation elements missing.");
                return; 
            }

            const bp = parseFloat(buyPriceEl.value)||0; 
            const dp = parseFloat(dailyPriceEl.value)||0; 
            const qty = parseFloat(quantityEl.value)||0;
            const slider = parseFloat(profitSliderEl.value)||0;
            const useTax = taxToggleEl.checked;
            const purchaseDateIso = purchaseDateEl.value;
            
            // --- CORE TARGET CALCULATION (Uses Buy Price / Invest) ---
            const rawValue = bp * qty; 
            const buyFee = calcFee(rawValue, assetMode); // Uses dynamic calcFee
            const invest = rawValue + buyFee;
            
            // Update Invest Breakdown display
            if (document.getElementById('purchaseDateDisplay')) document.getElementById('purchaseDateDisplay').textContent = fmtDateTime(purchaseDateIso);
            if (document.getElementById('rawShareValue')) document.getElementById('rawShareValue').textContent = fmt(rawValue);
            if (document.getElementById('buyFees')) document.getElementById('buyFees').textContent = fmt(buyFee);
            if (document.getElementById('totalInvested')) document.getElementById('totalInvested').textContent = fmt(invest);


            let netTarget = (profitMode==='EUR') ? slider : (invest * (slider/100));
            if (document.getElementById('targetProfitDisplay')) document.getElementById('targetProfitDisplay').textContent = (profitMode==='EUR') ? fmt(netTarget) : `${slider.toFixed(1)} % (${fmt(netTarget)})`;
            
            
            if(bp<=0 || qty<=0) { 
                // FIX: Added null check here just in case, though the safe texts above should cover it.
                if (document.getElementById('requiredSellPriceTotal')) document.getElementById('requiredSellPriceTotal').textContent = fmt(0);
                if (document.getElementById('requiredSellPriceShare')) document.getElementById('requiredSellPriceShare').textContent = fmt(0);
                if (document.getElementById('percentChangeTarget')) document.getElementById('percentChangeTarget').textContent = '+0.00 %';
                if (document.getElementById('totalFees')) document.getElementById('totalFees').textContent = fmt(0);
                if (document.getElementById('taxAmount')) document.getElementById('taxAmount').textContent = fmt(0);
                
                const currentPnLEl = document.getElementById('currentPnL');
                if (currentPnLEl) {
                    currentPnLEl.textContent = '+0.00 % (0,00 â‚¬)';
                    currentPnLEl.className = 'text-[11px] font-bold px-2 py-0.5 rounded text-slate-400 bg-slate-700/50 border border-slate-700';
                }
                renderCanvas(); 
                return; 
            }

            let grossTarget = netTarget; if(useTax && netTarget>0) grossTarget = netTarget / (1 - 0.26375);
            const payout = invest + grossTarget;
            
            // Selling Fee calculation uses Target Sale Volume (payout)
            // Stock-specific: Calculate potential sale volume needed to cover fixed fee correctly
            let sellVol;
            if (assetMode === 'STOCKS') {
                // Reverse calculation for stock fees (4.90 + 0.25%)
                sellVol = (payout + 4.90) / 0.9975; 
                if(calcFee(sellVol, assetMode) >= 69.90) sellVol = payout + 69.90; // Apply max fee if calculation exceeds it
            } else {
                // Crypto-specific: No complicated reversal needed due to percentage fee (0.005%)
                sellVol = payout / (1 - 0.00005);
            }
            
            const sellFee = calcFee(sellVol, assetMode); // Uses dynamic calcFee
            const grossProfit = sellVol - sellFee - invest;
            const taxVal = (useTax && grossProfit > 0) ? grossProfit * 0.26375 : 0;
            const reqPrice = sellVol / qty;
            const pctTarget = ((reqPrice - bp) / bp) * 100;
            
            // Target Result Display
            const el = document.getElementById('requiredSellPriceTotal');
            if(el) {
                if(Math.abs(sellVol - prevRes) > 0.01) { el.classList.remove('pulse-text'); void el.offsetWidth; el.classList.add('pulse-text'); prevRes = sellVol; }
                el.textContent = fmt(sellVol);
            }
            
            if (document.getElementById('requiredSellPriceShare')) document.getElementById('requiredSellPriceShare').textContent = fmt(reqPrice);
            if (document.getElementById('percentChangeTarget')) document.getElementById('percentChangeTarget').textContent = `${pctTarget >= 0 ? '+' : ''}${pctTarget.toFixed(2)} %`;
            
            if (document.getElementById('totalFees')) document.getElementById('totalFees').textContent = fmt(buyFee + sellFee); 
            if (document.getElementById('taxAmount')) document.getElementById('taxAmount').textContent = fmt(taxVal);
            
            // --- CURRENT P&L CALCULATION (Uses Daily Price) ---
            const currentSaleVol = (dp * qty); 
            const totalBuyFee = calcFee(bp * qty, assetMode);
            const totalSellFee = calcFee(currentSaleVol, assetMode);
            const initialInvestment = (bp * qty) + totalBuyFee;

            // P&L Netto (Exklusive Steuern)
            const currentGrossProfit = currentSaleVol - totalSellFee - initialInvestment;
            const currentNetProfit = currentGrossProfit; 
            
            const currentPct = (dp > 0 && bp > 0) ? ((dp - bp) / bp) * 100 : 0;

            const currentPnLEl = document.getElementById('currentPnL');
            if (currentPnLEl) {
                const colorClass = currentNetProfit >= 0 ? 'text-emerald-400 border-emerald-500/20 bg-emerald-500/10' : 'text-red-400 border-red-500/20 bg-red-500/10';
                const sign = currentNetProfit >= 0 ? '+' : '';

                currentPnLEl.className = `text-[11px] font-bold px-2 py-0.5 rounded ${colorClass} border`;
                currentPnLEl.textContent = `${sign}${currentPct.toFixed(2)} % (${fmt(currentNetProfit)})`;
            }

            renderCanvas(); // State-driven render
        }

        // === TRADES & SEARCH ===
        // Helper to calculate P&L for a specific trade, based on current daily price and tax setting
        function calculateTradePnL(trade, currentDailyPrice, includeTax) {
            const bp = parseFloat(trade.bp) || 0;
            const qty = parseFloat(trade.qty) || 0;
            const dp = parseFloat(currentDailyPrice) || 0;
            const tradeMode = trade.am || 'STOCKS'; // NEW: Use trade's asset mode
            
            if(bp <= 0 || qty <= 0 || dp <= 0) return { profit: 0, profitPct: 0 };

            const rawBuyValue = bp * qty;
            const buyFee = calcFee(rawBuyValue, tradeMode); // Use trade's mode
            const initialInvestment = rawBuyValue + buyFee;

            const rawSaleValue = dp * qty;
            const sellFee = calcFee(rawSaleValue, tradeMode); // Use trade's mode

            const grossProfit = rawSaleValue - sellFee - initialInvestment;

            let finalProfit = grossProfit;

            if (includeTax && grossProfit > 0) {
                const tax = grossProfit * 0.26375; 
                finalProfit = grossProfit - tax;
            }
            
            const profitPct = (dp / bp - 1) * 100;

            return { 
                profit: finalProfit, 
                profitPct: profitPct 
            };
        }


        window.saveTrade = function() {
            if(localStorage.getItem(KEYS.C)!=='true') return;
            const historyKey = getCurrentHistoryKey();

            const t = { 
                id: Date.now(), 
                sym: document.getElementById('searchInput').value || "Manuell", 
                date: document.getElementById('purchaseDate').value, 
                qty: document.getElementById('quantity').value, 
                tgt: document.getElementById('requiredSellPriceTotal').innerText,
                bp: document.getElementById('buyPrice').value, 
                am: assetMode // NEW: Save Asset Mode with the trade
            };
            // FIX: Append to the correct history list
            const l = JSON.parse(localStorage.getItem(historyKey)||'[]'); l.unshift(t);
            localStorage.setItem(historyKey, JSON.stringify(l)); AudioEngine.playSuccess(); showToast("Trade gesichert"); renderTrades();
        };

        function renderTrades() {
            const historyKey = getCurrentHistoryKey();
            // FIX: Load only the current mode's trades
            const trades = JSON.parse(localStorage.getItem(historyKey)||'[]');
            const el = document.getElementById('trades-list');
            const currentDailyPrice = parseFloat(document.getElementById('dailyPrice').value) || 0;
            const includeTax = document.getElementById('taxHistoryToggle').checked;

            if(trades.length===0) { el.innerHTML='<div class="text-center text-gray-600 text-xs italic mt-10">Keine EintrÃ¤ge.</div>'; return; }
            
            el.innerHTML = trades.map(x => {
                let pnl = calculateTradePnL(x, currentDailyPrice, includeTax);
                
                const pnlSign = pnl.profit >= 0 ? '+' : '';
                const pnlColor = pnl.profit >= 0 ? 'text-emerald-400' : 'text-red-400';
                const pnlText = `${pnlSign}${fmt(pnl.profit)} (${pnlSign}${pnl.profitPct.toFixed(2)} %)`;
                const todayText = currentDailyPrice > 0 ? `${fmt(currentDailyPrice)}` : 'N/A';
                const modeLabel = (x.am === 'CRYPTO') ? 'KRYPTO' : 'AKTIE';

                // NEU: Verbessertes, kompakteres Layout fÃ¼r die Historienkachel
                return `
                    <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-4 flex justify-between items-start interactive transition-all hover:bg-slate-700/50">
                        <!-- Left Block: Symbol, Date, P&L Label -->
                        <div class="flex flex-col gap-1">
                            <div class="flex items-center gap-2">
                                <span class="bg-emerald-800/50 text-white text-xs font-bold px-2 py-0.5 rounded">${x.sym}</span>
                                <span class="text-slate-400 text-xs">${new Date(x.date).toLocaleDateString()}</span>
                            </div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-widest mt-1">
                                ${modeLabel} P&L (${includeTax ? 'inkl. St.' : 'exkl. St.'})
                            </div>
                            <div class="mt-1">
                                <span class="text-xs font-mono text-slate-400">Kauf: ${fmt(x.bp)}</span>
                                <span class="text-slate-600 text-xs mx-1">|</span>
                                <span class="text-xs font-mono text-slate-400">Tageskurs: ${todayText}</span>
                            </div>
                        </div>

                        <!-- Right Block: P&L Value (big and colorful) -->
                        <div class="text-right flex flex-col items-end pt-1">
                            <p class="text-lg font-bold font-mono ${pnlColor} whitespace-nowrap leading-tight">${fmt(pnl.profit)}</p>
                            <p class="text-sm font-medium ${pnlColor} whitespace-nowrap mt-0.5 opacity-80">${pnlSign}${pnl.profitPct.toFixed(2)} %</p>
                            
                            <!-- Delete Button -->
                            <button onclick="delTrade(${x.id})" class="text-slate-500 hover:text-red-400 p-2 -mr-2 mt-2 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        window.delTrade = function(id) { 
            showModal('warn', 'LÃ¶schen?', 'Entfernen?', [{
                label:'LÃ¶schen', cls:'btn-action btn-danger', 
                cb:()=>{ 
                    const historyKey = getCurrentHistoryKey();
                    let l=JSON.parse(localStorage.getItem(historyKey)||'[]'); 
                    l=l.filter(x=>x.id!==id); 
                    localStorage.setItem(historyKey,JSON.stringify(l)); 
                    renderTrades(); 
                }}, 
                {label:'Abbrechen', cls:'btn-action btn-secondary'}
            ]); 
        };

        // FIX: Filtering in updateRecentsUI() applied
        function isCryptoSymbol(sym) {
            // Updated heuristic: Crypto symbols often contain '-' and are not common 1-5 letter stock symbols
            return sym.includes('-') || sym.length > 5; 
        }
        
        function addToRecents(sym) {
            const recentsKey = getCurrentRecentsKey();
            let h = JSON.parse(localStorage.getItem(recentsKey)||'[]');
            
            // This basic validation prevents mixing, though more precise filtering happens on render/load
            const isTargetCrypto = assetMode === 'CRYPTO';
            if ((isTargetCrypto && !isCryptoSymbol(sym)) || (!isTargetCrypto && isCryptoSymbol(sym))) {
                 return; 
            }
            
            h = h.filter(i => i !== sym); h.unshift(sym);
            if(h.length > 3) h.pop();
            localStorage.setItem(recentsKey, JSON.stringify(h));
            updateRecentsUI();
        }
        function updateRecentsUI() {
            const recentsKey = getCurrentRecentsKey();
            // FIX: Load only the current mode's recents
            const filteredRecents = JSON.parse(localStorage.getItem(recentsKey)||'[]');

            const c = document.getElementById('recent-searches');
            c.innerHTML = filteredRecents.map(s => `<span class="stock-badge" onclick="fetchPrice('${s}')">${s}</span>`).join('');
        }

        // --- TRENDING LOGIC ---
        const STOCK_TRENDS = ['MSFT', 'AMZN', 'GOOGL', 'TSLA', 'AAPL', 'NVDA', 'V', 'JNJ', 'WMT'];
        const CRYPTO_TRENDS = ['BTC-USD', 'ETH-USD', 'SOL-USD', 'ADA-USD', 'XRP-USD', 'DOGE-USD', 'DOT-USD', 'LINK-USD'];
        
        let trendingAssets = [];
        let trendingUpdateInterval;
        
        // Helper to fetch the current price and update the display for a single asset
        async function fetchTrendingPrice(sym) {
            const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?range=1d&interval=1d`;
            try {
                const d = await fetchSafe(apiUrl);
                const meta = d.chart?.result?.[0]?.meta;
                const close = d.chart?.result?.[0]?.indicators?.quote?.[0]?.close;
                
                if (meta && close && close.length > 0) {
                    const price = meta.regularMarketPrice || meta.regularMarketPreviousClose;
                    const prevClose = meta.chartPreviousClose;
                    if (price && prevClose) {
                        const changePct = ((price - prevClose) / prevClose) * 100;
                        return { symbol: sym, changePct: changePct, price: price };
                    }
                }
            } catch(e) {
                // console.warn(`Failed to fetch price for trending asset ${sym}`);
            }
            return { symbol: sym, changePct: (Math.random() * 5 - 2.5), price: 0 }; // Fallback random change
        }

        window.fetchTrendingAssets = async function(manualRefresh = false) {
            const list = document.getElementById('trending-list');
            if (!list) return;

            if (!manualRefresh && trendingAssets.length > 0) {
                 // Nur Preise aktualisieren, wenn schon Assets geladen sind
                 list.innerHTML = `<div class="col-span-2 text-center text-slate-500 text-xs mt-1">Aktualisiere...</div>`;
            } else {
                 // Neue Assets wÃ¤hlen, wenn manueller Refresh oder leer
                 const pool = assetMode === 'CRYPTO' ? CRYPTO_TRENDS : STOCK_TRENDS;
                 const shuffled = pool.sort(() => 0.5 - Math.random());
                 const selected = shuffled.slice(0, 4); // Top 4 random
                 trendingAssets = selected.map(sym => ({ symbol: sym, changePct: 0, price: 0 }));
            }
            
            const promises = trendingAssets.map(asset => fetchTrendingPrice(asset.symbol));
            const results = await Promise.all(promises);
            
            // Update the global trendingAssets with fresh data
            trendingAssets = results.filter(r => r); 
            
            // Render the updated list
            renderTrendingList();
        }

        function renderTrendingList() {
            const list = document.getElementById('trending-list');
            if (!list) return;

            if (trendingAssets.length === 0) {
                 list.innerHTML = `<div class="col-span-2 text-center text-gray-600 text-xs italic mt-2">Keine Trending Assets gefunden.</div>`;
                 return;
            }
            
            list.innerHTML = trendingAssets.map(asset => {
                const isPositive = asset.changePct >= 0;
                const colorClass = isPositive ? 'text-emerald-400' : 'text-red-400';
                const sign = isPositive ? '+' : '';

                return `
                    <div class="p-3 bg-slate-900/40 rounded-xl border border-slate-700/50 flex flex-col justify-between interactive transition-colors hover:bg-slate-700/50" onclick="fetchPrice('${asset.symbol}')">
                        <span class="text-white font-bold text-sm">${asset.symbol}</span>
                        <span class="text-xs ${colorClass} font-mono mt-1">${sign}${asset.changePct.toFixed(2)} %</span>
                    </div>
                `;
            }).join('');
        }

        // Setup periodic update for trending assets
        if (trendingUpdateInterval) {
            clearInterval(trendingUpdateInterval);
        }
        trendingUpdateInterval = setInterval(() => {
            if (!document.getElementById('main-card').classList.contains('is-flipped')) {
                // Update trending data only if the front side is visible
                fetchTrendingAssets();
            }
        }, 120000); // Update every 2 minutes (120,000 ms)


        const PX = [ {u:t=>`https://corsproxy.io/?${encodeURIComponent(t)}`, e:d=>d}, {u:t=>`https://api.allorigins.win/get?url=${encodeURIComponent(t)}`, e:d=>JSON.parse(d.contents)} ];
        async function fetchSafe(u) {
            for(let p of PX) { try {
                const c = new AbortController(); setTimeout(()=>c.abort(),3000);
                const r = await fetch(p.u(u), {signal:c.signal}); if(!r.ok) throw 1; return p.e(await r.json());
            } catch(e){} } throw "Err";
        }
        window.searchStock = async function() {
            const q=document.getElementById('searchInput').value; if(!q)return;
            const r=document.getElementById('searchResults'), l=document.getElementById('loadingIndicator');
            r.innerHTML=''; r.classList.add('hidden'); l.classList.remove('hidden');
            
            // NEW: Select search URL based on assetMode
            const baseUrl = assetMode === 'CRYPTO'
                ? `https://query1.finance.yahoo.com/v1/finance/search?q=${q}&quotesCount=5&newsCount=0&enableFuzzyQuery=false&quotesQueryId=cryptocurrency`
                : `https://query1.finance.yahoo.com/v1/finance/search?q=${q}&quotesCount=5`;

            try {
                const d = await fetchSafe(baseUrl);
                l.classList.add('hidden');
                
                // Use quotes array which works for both modes
                if(d.quotes?.length) {
                    r.classList.remove('hidden');
                    d.quotes.forEach(s => {
                        // Filter out non-matching asset types in case the search was broad
                        if (assetMode === 'CRYPTO' && s.quoteType !== 'CRYPTOCURRENCY') return;
                        if (assetMode === 'STOCKS' && s.quoteType === 'CRYPTOCURRENCY') return;

                        const div = document.createElement('div');
                        div.className="p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700 flex justify-between items-center interactive";
                        div.innerHTML=`<div><div class="font-bold text-slate-200 text-sm">${s.symbol}</div><div class="text-[10px] text-slate-500">${s.shortname||s.longname}</div></div>`;
                        div.onmousedown=(e)=>{e.preventDefault(); fetchPrice(s.symbol);}; r.appendChild(div);
                    });
                    if (r.children.length === 0) showToast("Keine passenden Ergebnisse gefunden");
                } else showToast("Nichts gefunden");
            } catch(e){ l.classList.add('hidden'); showToast("Fehler bei der Suche"); }
        };
        async function fetchPrice(s) {
            document.getElementById('searchResults').classList.add('hidden'); document.getElementById('searchInput').value=s;
            document.getElementById('loadingIndicator').classList.remove('hidden');
            
            const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${s}?range=max&interval=1mo`;

            try {
                const d = await fetchSafe(apiUrl);
                const meta = d.chart?.result?.[0]?.meta;
                const p = meta?.regularMarketPrice || meta?.regularMarketPreviousClose; // Use previous close as fallback

                if(d.chart?.result?.[0]?.indicators?.quote?.[0]?.close) {
                    const q = d.chart.result[0].indicators.quote[0].close;
                    const t = d.chart.result[0].timestamp;
                    chartData = { quotes: q.filter(n=>n!==null), stamps: t.filter((_,i)=>q[i]!==null) };
                }

                const yahooLinkBase = (assetMode === 'CRYPTO') ? `https://finance.yahoo.com/quote/${s}` : `https://finance.yahoo.com/quote/${s}`;
                document.getElementById('yahooLink').href = yahooLinkBase;
                
                if(p) { 
                    AudioEngine.playSuccess(); 
                    document.getElementById('dailyPrice').value=p.toFixed(2);
                    addToRecents(s); 
                    toggleDailyPriceEdit(); // Jetzt deaktiviert es, da Symbol gesetzt ist
                    saveAndCalc();
                    renderTrades();
                } else {
                    showToast("Kein aktueller Kurs gefunden");
                }
            } catch(e){ showToast("Fehler beim Abruf des Kurses"); } finally { document.getElementById('loadingIndicator').classList.add('hidden'); }
        }

        // === CHART RENDERING (Pure & Safe) ===
        let chartRenderInterval;
        function renderCanvas(mouseX, mouseY) {
            const canvas = document.getElementById('bg-canvas'); const ctx = canvas.getContext('2d');
            
            // Only resize if dimensions differ (avoids loop)
            if (canvas.width !== window.innerWidth || canvas.height !== window.innerHeight) {
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            }
            const w = canvas.width; const h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            if (!chartData || !chartData.quotes.length) return;
            const hist = chartData.quotes;

            // Markers from DOM (Read-only here)
            const bp = parseFloat(document.getElementById('buyPrice').value) || 0;
            const dp = parseFloat(document.getElementById('dailyPrice').value) || 0;
            const q = parseFloat(document.getElementById('quantity').value) || 1;
            
            // FIX: Use safe retrieval of innerText which is formatted currency string
            const requiredSellPriceTotalEl = document.getElementById('requiredSellPriceTotal');
            const tpTotalText = requiredSellPriceTotalEl ? requiredSellPriceTotalEl.innerText : '0,00 â‚¬';
            const tpTotal = parseFloat(tpTotalText.replace('.','').replace(',','.').replace(' â‚¬','')) || 0;
            
            const tp = tpTotal / (q > 0 ? q : 1);

            // Dynamic Range
            let vals = [...hist]; if(bp>0) vals.push(bp); if(tp>0) vals.push(tp); if(dp>0) vals.push(dp);
            const min = Math.min(...vals) * 0.95; const max = Math.max(...vals) * 1.05; const rng = max - min;
            const step = w / (hist.length - 1);
            const getY = (p) => h - ((p - min) / rng * h * 0.6) - (h * 0.2);

            // Draw Graph
            ctx.beginPath(); ctx.lineWidth = 3; ctx.strokeStyle = '#10B981'; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            hist.forEach((p, i) => { const x = i*step; const y = getY(p); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
            ctx.stroke();
            
            // Fill
            ctx.lineTo(w, h); ctx.lineTo(0, h); ctx.closePath();
            const grad = ctx.createLinearGradient(0, 0, 0, h); grad.addColorStop(0, 'rgba(16, 185, 129, 0.1)'); grad.addColorStop(1, 'rgba(16, 185, 129, 0)');
            ctx.fillStyle = grad; ctx.fill();

            // Markers (Static or Hover)
            if(mouseX !== undefined) {
                const idx = Math.round(mouseX / step);
                if(idx >= 0 && idx < hist.length) {
                    const p = hist[idx]; const x = idx * step; const y = getY(p);
                    const tt = document.getElementById('chart-tooltip');
                    tt.style.display = 'block'; tt.style.left = (x+15)+'px'; tt.style.top = y+'px';
                    if(mouseX > w-150) tt.style.left = (x-15)+'px'; tt.style.transform = mouseX > w-150 ? 'translate(-100%, -50%)' : 'translate(0, -50%)';
                    tt.innerHTML = `${p.toFixed(2)}â‚¬<br><span class="text-slate-400 text-[9px]">${new Date(chartData.stamps[idx]*1000).toLocaleDateString()}</span>`;
                    ctx.beginPath(); ctx.fillStyle = '#fff'; ctx.arc(x, y, 5, 0, Math.PI*2); ctx.fill();
                }
            } else {
                if(bp > 0) { const by = getY(bp); ctx.beginPath(); ctx.setLineDash([4,4]); ctx.strokeStyle='#94a3b8'; ctx.lineWidth=1; ctx.moveTo(0,by); ctx.lineTo(w,by); ctx.stroke(); ctx.setLineDash([]); ctx.beginPath(); ctx.fillStyle='#64748b'; ctx.arc(w-20, by, 4, 0, Math.PI*2); ctx.fill(); }
                if(tp > 0) { const ty = getY(tp); ctx.beginPath(); ctx.strokeStyle='#10b981'; ctx.lineWidth=1; ctx.moveTo(0,ty); ctx.lineTo(w,ty); ctx.stroke(); ctx.beginPath(); ctx.fillStyle='#10b981'; ctx.arc(w-20, ty, 6, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.fillStyle='rgba(16,185,129,0.3)'; ctx.arc(w-20, ty, 12, 0, Math.PI*2); ctx.fill(); }
                // New: Daily Price marker
                if(dp > 0) { 
                    const dy = getY(dp); 
                    ctx.beginPath(); 
                    ctx.setLineDash([2, 4]); // Dotted line for Daily Price
                    ctx.strokeStyle='#3b82f6'; // A light blue/primary color for daily price
                    ctx.lineWidth=1; 
                    ctx.moveTo(0, dy); 
                    ctx.lineTo(w, dy); 
                    ctx.stroke(); 
                    ctx.setLineDash([]); 
                    ctx.beginPath(); 
                    ctx.fillStyle='#3b82f6'; 
                    ctx.arc(w - 20, dy, 4, 0, Math.PI * 2); 
                    ctx.fill(); 
                }
            }
        }

        // Hover Event
        document.addEventListener('mousemove', (e) => {
            if(e.target.classList.contains('bg-overlay') || e.target.id==='bg-canvas') renderCanvas(e.clientX, e.clientY);
            else { document.getElementById('chart-tooltip').style.display='none'; renderCanvas(); }
        });
        
        // Render Canvas every 50ms for smooth marker display when price changes dynamically
        if (chartRenderInterval) {
            clearInterval(chartRenderInterval);
        }
        chartRenderInterval = setInterval(() => {
            renderCanvas();
        }, 50);


        // Export/Import
        window.exportData = function() {
            // FIX: Export all relevant keys
            const d = { 
                u: localStorage.getItem(KEYS.U), 
                c: localStorage.getItem(KEYS.C),
                d_stocks: JSON.parse(localStorage.getItem(KEYS.D_STOCKS) || 'null'),
                d_crypto: JSON.parse(localStorage.getItem(KEYS.D_CRYPTO) || 'null'),
                t_stocks: JSON.parse(localStorage.getItem(KEYS.T_STOCKS) || 'null'),
                t_crypto: JSON.parse(localStorage.getItem(KEYS.T_CRYPTO) || 'null'),
                h_stocks: JSON.parse(localStorage.getItem(KEYS.H_STOCKS) || 'null'),
                h_crypto: JSON.parse(localStorage.getItem(KEYS.H_CRYPTO) || 'null')
            };
            const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(d)],{type:'application/json'}));
            a.download=`TradePilot_Backup_${new Date().toISOString().slice(0, 10)}.json`; a.click();
            showToast("Daten gespeichert");
        }
        window.importData = function(i) {
            const f=i.files[0]; if(!f)return; const r=new FileReader();
            r.onload=e=>{ 
                try{ 
                    const d=JSON.parse(e.target.result); 
                    // FIX: Import all relevant keys
                    if(d.u)localStorage.setItem(KEYS.U,d.u); 
                    if(d.c)localStorage.setItem(KEYS.C,d.c);
                    
                    if(d.d_stocks)localStorage.setItem(KEYS.D_STOCKS,JSON.stringify(d.d_stocks));
                    if(d.d_crypto)localStorage.setItem(KEYS.D_CRYPTO,JSON.stringify(d.d_crypto));
                    
                    if(d.t_stocks)localStorage.setItem(KEYS.T_STOCKS,JSON.stringify(d.t_stocks));
                    if(d.t_crypto)localStorage.setItem(KEYS.T_CRYPTO,JSON.stringify(d.t_crypto));
                    
                    if(d.h_stocks)localStorage.setItem(KEYS.H_STOCKS,JSON.stringify(d.h_stocks));
                    if(d.h_crypto)localStorage.setItem(KEYS.H_CRYPTO,JSON.stringify(d.h_crypto));
                    
                    location.reload(); 
                }catch(x){ showToast("Fehler beim Importieren der Daten"); }
            }; 
            r.readAsText(f);
        }
        function showToast(msg) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div'); t.className = 'toast';
            t.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><span>${msg}</span>`;
            c.appendChild(t); requestAnimationFrame(()=>t.classList.add('show'));
            setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(), 2000); }, 2000);
        }
        function showModal(t, tl, m, acts) {
            const b=document.getElementById('modal-backdrop'), d=document.getElementById('generic-modal');
            document.getElementById('modal-icon').textContent = t==='warn'?'âš ï¸':'ðŸ›¡ï¸';
            document.getElementById('modal-title').textContent = tl; document.getElementById('modal-text').textContent = m;
            const ac = document.getElementById('modal-actions'); ac.innerHTML='';
            acts.forEach(a=>{ const x=document.createElement('button'); x.textContent=a.label; x.className=a.cls; x.onclick=()=>{closeModal(); if(a.cb)a.cb();}; ac.appendChild(x); });
            b.style.display='block'; d.style.display='flex'; requestAnimationFrame(()=>{b.classList.add('show'); d.classList.add('show');});
        }
        function closeModal() {
            const b=document.getElementById('modal-backdrop'), d=document.getElementById('generic-modal');
            b.classList.remove('show'); d.classList.remove('show'); setTimeout(()=>{b.style.display='none'; d.style.display='none';},300);
        }
        
        // Initial check to hide the unmute button if audio permission is already granted in the past
        // This relies on the browser's ability to check permission state, which might vary.
        document.addEventListener("DOMContentLoaded", () => {
            if (window.AudioContext || window.webkitAudioContext) {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                if (ctx.state === 'running' || localStorage.getItem('audio_unlocked') === 'true') {
                    AudioEngine.isUnlocked = true;
                    document.getElementById('unmuteButton').classList.add('hidden');
                } else {
                    document.getElementById('unmuteButton').classList.remove('hidden');
                }
            } else {
                // Hide button if no AudioContext API is available
                document.getElementById('unmuteButton').classList.add('hidden');
            }

            // Load Asset Mode on startup
            const savedState = localStorage.getItem(getCurrentDataKey());
            if (savedState) {
                try {
                    const d = JSON.parse(savedState);
                    if (d.am) {
                         assetMode = d.am;
                         document.getElementById('assetModeToggle').checked = (assetMode === 'CRYPTO');
                    }
                } catch(e) { /* ignore */ }
            }
            updateAssetUI(); // Ensure UI reflects the loaded/default mode immediately
            window.initConsent();
        });
    </script>


</body></html>
